name: Python Reusable Workflow

'on':
  workflow_call:
    inputs:
      working-directory:
        description: 'Directory to run commands in'
        required: true
        type: string
      src-directory:
        description: 'Directory containing source code'
        required: true
        type: string
      tests-directory:
        description: 'Directory containing tests'
        required: true
        type: string
      coverage-file:
        description: 'Coverage XML file path'
        required: true
        type: string
      artifact-name:
        description: 'Name for uploaded artifact'
        required: true
        type: string
      artifact-path:
        description: 'Path for artifact upload'
        required: true
        type: string

jobs:
  python-tests:
    name: Test Python Package
    permissions:
      contents: read  # Required for checking out the code
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout Repository
        # v6.0.1
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Setup Python
      # v6.1.0
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548
        with:
          python-version: "3.12"

      - name: Install Poetry
        env:
          POETRY_HOME: ${{ runner.temp }}/poetry
        run: |
          python -m pip install --upgrade pip
          curl -sSL https://install.python-poetry.org | python -

      - name: Add Poetry to PATH (Linux/macOS)
        if: runner.os != 'Windows'
        run: echo "${{ runner.temp }}/poetry/bin" >> $GITHUB_PATH

      - name: Add Poetry to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "${{ runner.temp }}\poetry\bin" |
            Out-File -FilePath $env:GITHUB_PATH -Encoding utf8

      - name: Install dev dependencies
        run: poetry install --with dev

      # ───── Docker setup (for system tests) ─────
      - name: Check Docker availability (Linux)
        if: runner.os == 'Linux'
        run: |
          # Docker is pre-installed on Ubuntu runners
          # Just ensure the service is running
          docker --version

      - name: Install Docker on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Install Chocolatey if not present
          if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = `
              [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString(`
              'https://chocolatey.org/install.ps1'))
          }
          # Install Docker Desktop
          choco install docker-desktop -y
          # Refresh PATH
            $env:Path = [System.Environment]::GetEnvironmentVariable(`
            "Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable(`
            "Path","User")
          # Start Docker service
          Start-Service docker

      - name: Install Docker on macOS
        if: runner.os == 'macOS'
        run: |
          # Install Docker Desktop using Homebrew
          brew install --cask docker
          # Start Docker (may require user interaction, but in CI it might work)
          open /Applications/Docker.app
          # Wait for Docker to start
          sleep 30
          docker --version

      - name: Run pylint (min score 9.0)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          poetry run pylint ${{ inputs.src-directory }} ${{ inputs.tests-directory }} --rcfile=${GITHUB_WORKSPACE}/.pylintrc --fail-under=9.0
            
      - name: Run pytest (with coverage, Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          poetry run pytest --cov=${{ inputs.src-directory }} --cov-report=xml \
            --cov-report=term-missing

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest'
        # v5
        uses: codecov/codecov-action@c23a129e932ebdcb56ca1565c68c6abdbf173769
        with:
          files: ${{ inputs.coverage-file }}
          flags: cli-tests
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  build-python-package:
    name: Build Python Package
    needs: [python-tests]
    permissions:
      contents: read  # Required for checking out the code
      actions: write  # Required for uploading artifacts
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout Repository
        # v6.0.1
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Setup Python
      # v6.1.0
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548
        with:
          python-version: "3.12"

      - name: Install Poetry
        env:
          POETRY_HOME: ${{ runner.temp }}/poetry
        run: |
          python -m pip install --upgrade pip
          curl -sSL https://install.python-poetry.org | python -

      - name: Add Poetry to PATH
        run: echo "${{ runner.temp }}/poetry/bin" >> $GITHUB_PATH

      - name: Install runtime dependencies
        run: poetry install --only main

      - name: Build wheel and sdist
        run: |
          poetry build --format wheel
          poetry build --format sdist

      - name: Upload dist artefacts
        if: matrix.os == 'ubuntu-latest'
        # v6.0.0
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-path }}
          retention-days: 1
